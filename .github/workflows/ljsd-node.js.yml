# No m b re del wo rkflo w que aparecerá en la pestañ a Actio n s de GitH u b 
name : CI/CD Pipeline 
# Defin e cuá nd o se ejecu ta rá este wo rkflo w 
on: 
  # Se eje cuta cuan d o hay un push a las ram as esp ecificad a s 
  push: 
    branches: 
      - main        # Ram a princip a l 
      - develop     # Ram a de desarro llo (op cion a l, pue d e s elim in a rla si no la usa s) 
  

# Se eje cuta cuan d o se crea un Pull Req u est hacia esta s ram as 
  pull_request: 
    branches : 
      - main 
      - develop 
 
# Define las variab les de entorno globales para todos los jobs 
env: 
  NODE_VERSION: '20.x'  # Versión de Node .js a utilizar 
 
# Define los trabajos (jobs) que se ejecutarán 
jobs: 
 
  # ================================================== 
  # JOB 1: LINTING Y VERIF ICACIÓN DE CÓD IGO 
  # ================================================== 
 
  lint: 
    name:  Lint Code 
    runs-on: ubuntu-latest # Sistema operat ivo donde se ejecutará 
 
    steps: 
      # Descarga el cód igo del repositorio 
      - name: Checkout code 
        uses: actions/checkout@v4 
 
      # Configura Node.js en el runner 
      - name: Setup Node.js 
        uses: actions/setup-node@v4 
        with: 
          node-version: ${{ env.NODE_VERSION }} 
          cache: 'npm' # Cachea las dependencias de npm para acelerar builds 
 
      # Instala las dependencias del proyecto 
      - name: Install dependencies 
        run: npm ci # ci es más rápido y confiab le que install para CI 
 
      # Ejecuta ESLint para verificar la calidad del código 
      - name: Run ESLint 
        run: npm run lint 
 
  # ================================================== 
  # JOB 2: BUILD DEL PROYECTO 
  # ================================================== 
 
  build: 
    name: Build Application 
    runs-on: ubuntu-latest 
    needs: lint # Este job espera a que 'lint' term ine exitosamente 
 
    steps: 
    # Descarga el código del repositorio 
      - name: Checkout code 
        uses: actions/checkout@v4 
 
      - name: Setup Node.js 
        uses: actions/setup-node@v4 
        with: 
          node-version: ${{ env.NODE_VERSION }} 
          cache: 'npm' 
 
      - name: Install dependencies 
        run: npm ci 
 
      # Genera el cliente de Prisma (necesario para el build) 
      - name: Generate Prisma Client 
        run: npx prisma generate 
 
      # Comp ila la aplicación NestJS 
      - name: Build project 
        run: npm run build 
 
      # Guarda los artefactos del build para usarlos en otros jobs 
      - name: Upload build artifacts 
        uses: actions/up load-artifact@v4 
        with: 
          name : dist 
          path: dist/ 
          retention-days: 1  # Mantiene los artefactos por 1 día 
 
  # ================================================== 
  # JOB 3: TESTS UNITARIOS 
  # ================================================== 
  test: 
    name: Run Tests 
    runs-on: ubuntu-latest 
    needs: build # Espera a que el build term ine 
 
    steps: 
      - name: Checkout code 
        uses: actions/checkout@v4 
 
      - name: Setup Node.js 
        uses: actions/setup-node@v4 
        with: 
          node-version: ${{ env.NODE_VERSION }} 
          cache: 'npm' 
 
      - name: Install dependencies 
        run: npm ci 
 
      - name: Generate Prisma Client 
        run: npx prisma generate 
 
      # Ejecuta los tests unitarios con Jest 
      - name: Run unit tests 
        run: npm run test -- --passWithNoTests 
        # --passW ithNoTests perm ite que pase aunque no haya tests (útil al iniciar) 
 
      # Ejecuta los tests con cobertura de cód igo 
      - name: Run tests with coverage 
        run: npm run test:cov -- --passWithNoTests 
 
      # Sube el reporte de cobertura como artefacto 
      # Sube el reporte de cobertura como artefacto 
      - name: Upload coverage report 
        uses: actions/upload-artifact@v4 
        with: 
          name : coverage-report 
          path: coverage/ 
          retention-days: 7 
 
  # ================================================== 
  # JOB 4: NOTIF ICACIÓN DE ESTADO (OPCIONAL) 
  # ================================================== 
 
  notify: 
    name: Notify Status 
    runs-on: ubuntu-latest 
    needs: [test] 
    if: always() # Se ejecuta siempre, incluso si hay fallos 
 
    steps: 
      - name: Check workflow status 
        run: | 
          echo "Pipe line execution comp leted!" 
          echo "Dep loy status: ${{ needs.dep loy.result }}" 
